# Build the sample Ruby gem with version from versionator

VERSIONATOR := "../../bin/versionator"

# Generate version.rb from versionator
version-file:
    #!/bin/bash
    set -e
    echo "Generating version.rb using versionator emit..."
    {{VERSIONATOR}} emit ruby --output lib/mypackage/version.rb

# Build the gem (generates version.rb first)
build: version-file
    #!/bin/bash
    set -e
    echo "Building Ruby gem..."
    gem build mypackage.gemspec
    echo "Build completed!"

# Install the gem locally
install: build
    gem install mypackage-*.gem

# Run the sample application
run: version-file
    ruby bin/mypackage

# Clean build artifacts
clean:
    rm -f lib/mypackage/version.rb
    rm -f *.gem

# Show the version that would be used
show-version:
    #!/bin/bash
    VERSION=$({{VERSIONATOR}} version 2>/dev/null || echo "NOT SET")
    echo "Version from versionator: $VERSION"

# Run tests
test: version-file
    bundle exec rspec 2>/dev/null || echo "No tests found or rspec not installed"

# Generate using custom template file
version-file-template:
    #!/bin/bash
    set -e
    echo "Generating version.rb using template file..."
    {{VERSIONATOR}} emit --template-file lib/mypackage/version.rb.tmpl --output lib/mypackage/version.rb

# Release helpers
release-patch:
    #!/bin/bash
    set -e
    {{VERSIONATOR}} patch increment
    just build

release-minor:
    #!/bin/bash
    set -e
    {{VERSIONATOR}} minor increment
    just build

release-major:
    #!/bin/bash
    set -e
    {{VERSIONATOR}} major increment
    just build
